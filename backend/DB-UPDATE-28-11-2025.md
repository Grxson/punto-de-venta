# Actualización de Base de Datos - 28/11/2025

## Problema
La migración de Hibernate intenta hacer la columna `activo` de la tabla `metodos_pago` como `NOT NULL`, pero existen registros con valores `NULL` en esa columna.

## Solución
Ejecutar el siguiente script SQL en tu base de datos PostgreSQL en Railway:

```sql
-- 1. Actualizar todos los valores NULL a true (activo por defecto)
UPDATE metodos_pago SET activo = true WHERE activo IS NULL;

-- 2. Añadir default true a la columna
ALTER TABLE metodos_pago ALTER COLUMN activo SET DEFAULT true;

-- 3. Hacer la columna NOT NULL
ALTER TABLE metodos_pago ALTER COLUMN activo SET NOT NULL;
```

## Instrucciones en Railway

### Opción 1: Usar Railway CLI (recomendado)
```bash
# 1. Conectar a BD
railway connect -d punto-de-venta

# 2. Ejecutar el script
UPDATE metodos_pago SET activo = true WHERE activo IS NULL;
ALTER TABLE metodos_pago ALTER COLUMN activo SET DEFAULT true;
ALTER TABLE metodos_pago ALTER COLUMN activo SET NOT NULL;
```

### Opción 2: Usar pgAdmin o DBeaver
1. Conectar a BD en Railway
2. Abrir query editor
3. Copiar y ejecutar el script de arriba

### Opción 3: Script en PostgreSQL directamente
```bash
psql -h <railway_host> -U <usuario> -d <database> -f fix-metodos-pago.sql
```

## Verificar que funcionó
```sql
SELECT column_name, data_type, is_nullable 
FROM information_schema.columns 
WHERE table_name = 'metodos_pago' AND column_name = 'activo';
```

Debería retornar:
- `is_nullable` = NO
- `data_type` = boolean

## Cambios en código (ya pusheados)

### Frontend
- ✅ Dockerfile ahora inyecta variables VITE_API_URL_PROD, VITE_API_URL_STAGING en build time
- ✅ Las variables se pasan como ARG y luego como ENV

### Backend
- ✅ Script SQL creado en `backend/src/main/resources/db/fix-metodos-pago.sql`
- ✅ WebSocketConfig ya tiene CORS correcto para /ws endpoint

## Railway redeploy
- ✅ Backend se redesplegó con WebSocket CORS arreglado
- ⏳ Frontend se redesplegará con variables de entorno correctas

## Próximos pasos
1. Ejecutar el script SQL en la BD de Railway
2. Esperar a que Railway termine de desplegar frontend (5-10 min)
3. Probar acceso a https://punto-de-venta-production-d424.up.railway.app

Los errores de CORS deberían desaparecer una vez que:
1. BD sea actualizada (columna activo)
2. Frontend sea compilado con VITE_API_URL_PROD correcto
