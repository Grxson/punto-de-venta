# ğŸ—ï¸ Diagrama: Sistema Multi-Sucursal Completo\n\n## 1. Diagrama E-R (Entidad-RelaciÃ³n)\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                      PRODUCTOS (Global)                         â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚\nâ”‚  â”‚ id (PK)                                                  â”‚  â”‚\nâ”‚  â”‚ nombre: \"Jugo\", \"CafÃ©\", \"Croissant\"                   â”‚  â”‚\nâ”‚  â”‚ descripcion: \"Jugo fresco de naranja\"                  â”‚  â”‚\nâ”‚  â”‚ precio: 2.50 (precio base)                             â”‚  â”‚\nâ”‚  â”‚ categoria_id (FK) â†’ CategoriaProducto                  â”‚  â”‚\nâ”‚  â”‚ activo: true                                            â”‚  â”‚\nâ”‚  â”‚ disponible_en_menu: true                               â”‚  â”‚\nâ”‚  â”‚ sku: \"SKU-001\"                                          â”‚  â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚\nâ”‚                           â”‚                                      â”‚\nâ”‚                           â”‚ 1:N                                  â”‚\nâ”‚                           â–¼                                      â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚\nâ”‚  â”‚         SUCURSAL_PRODUCTOS (ConfiguraciÃ³n)             â”‚  â”‚\nâ”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚\nâ”‚  â”‚  â”‚ id (PK)                                            â”‚ â”‚  â”‚\nâ”‚  â”‚  â”‚ sucursal_id (FK) â”€â”€â”€â”€â”€â”€â”                          â”‚ â”‚  â”‚\nâ”‚  â”‚  â”‚ producto_id (FK) â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”                     â”‚ â”‚  â”‚\nâ”‚  â”‚  â”‚ precio_sucursal: 2.50 (precio especÃ­fico) â”‚ â”‚  â”‚\nâ”‚  â”‚  â”‚ disponible: true                           â”‚ â”‚  â”‚\nâ”‚  â”‚  â”‚ orden_visualizacion: 1                     â”‚ â”‚  â”‚\nâ”‚  â”‚  â”‚ stock_maximo: 50                           â”‚ â”‚  â”‚\nâ”‚  â”‚  â”‚ horario_disponibilidad: JSON               â”‚ â”‚  â”‚\nâ”‚  â”‚  â”‚ dias_disponibilidad: JSON                  â”‚ â”‚  â”‚\nâ”‚  â”‚  â”‚ notas: \"Texto especial\"                    â”‚ â”‚  â”‚\nâ”‚  â”‚  â”‚ UNIQUE(sucursal_id, producto_id)          â”‚ â”‚  â”‚\nâ”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚\nâ”‚  â”‚                                 â”‚                        â”‚  â”‚\nâ”‚  â”‚                                 â”œâ”€â”€â”€â”€â”˜                   â”‚  â”‚\nâ”‚  â”‚                                 â”‚                        â”‚  â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚\nâ”‚                           â”‚                                      â”‚\nâ”‚                           â”‚                                      â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                            â”‚\n                            â–¼\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                   SUCURSALES (Tiendas)                          â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚\nâ”‚  â”‚ id (PK)                                                  â”‚  â”‚\nâ”‚  â”‚ nombre: \"Centro\", \"Sur\", \"Oeste\"                       â”‚  â”‚\nâ”‚  â”‚ direccion: \"Calle Principal 123\"                        â”‚  â”‚\nâ”‚  â”‚ activa: true                                             â”‚  â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n---\n\n## 2. Diagrama de Capas (Backend)\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                    CLIENTE (Frontend)                               â”‚\nâ”‚  GET /api/sucursales/productos                                      â”‚\nâ”‚  Authorization: Bearer eyJhbGciOiJIUzI1NiIs...                     â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                              â†“ HTTP\n                              \nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚              CAPA DE CONTROLADOR (REST API)                         â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚\nâ”‚  â”‚ SucursalController                                           â”‚  â”‚\nâ”‚  â”‚                                                              â”‚  â”‚\nâ”‚  â”‚ @GetMapping(\"/productos\")                                   â”‚  â”‚\nâ”‚  â”‚ public ResponseEntity<List<ProductoSucursalDTO>>          â”‚  â”‚\nâ”‚  â”‚ obtenerProductosMiSucursal() {                            â”‚  â”‚\nâ”‚  â”‚   // Sucursal ya estÃ¡ en contexto (del Filter)            â”‚  â”‚\nâ”‚  â”‚   return sucursalProductoService.obtenerProductos();      â”‚  â”‚\nâ”‚  â”‚ }                                                           â”‚  â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                              â†“\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚         CAPA DE FILTRO (Interceptor - Establece Contexto)          â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚\nâ”‚  â”‚ SucursalContextFilter                                        â”‚  â”‚\nâ”‚  â”‚                                                              â”‚  â”‚\nâ”‚  â”‚ 1. Extrae JWT del header \"Authorization\"                   â”‚  â”‚\nâ”‚  â”‚ 2. Decodifica JWT â†’ obtiene username                       â”‚  â”‚\nâ”‚  â”‚ 3. Busca Usuario en BD                                     â”‚  â”‚\nâ”‚  â”‚ 4. Lee usuario.sucursal_id                                 â”‚  â”‚\nâ”‚  â”‚ 5. ThreadLocal: SucursalContext.setSucursal(id, nombre)   â”‚  â”‚\nâ”‚  â”‚                                                              â”‚  â”‚\nâ”‚  â”‚ Resultado: SucursalContext disponible en todas las capas   â”‚  â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                              â†“\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚              CAPA DE SERVICIO (LÃ³gica de Negocio)                  â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚\nâ”‚  â”‚ SucursalProductoService                                      â”‚  â”‚\nâ”‚  â”‚                                                              â”‚  â”‚\nâ”‚  â”‚ obtenerProductosDisponibles() {                            â”‚  â”‚\nâ”‚  â”‚   Long sucursalId = SucursalContext.getSucursalId();      â”‚  â”‚\nâ”‚  â”‚   return repository.findBySucursalIdAndDisponible(...)    â”‚  â”‚\nâ”‚  â”‚     .stream()                                              â”‚  â”‚\nâ”‚  â”‚     .map(this::mapToDTO)                                  â”‚  â”‚\nâ”‚  â”‚     .toList();                                             â”‚  â”‚\nâ”‚  â”‚ }                                                           â”‚  â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                              â†“\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚          CAPA DE REPOSITORIO (Acceso a Datos - Spring Data)        â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚\nâ”‚  â”‚ SucursalProductoRepository                                   â”‚  â”‚\nâ”‚  â”‚                                                              â”‚  â”‚\nâ”‚  â”‚ @Query(\"SELECT sp FROM SucursalProducto sp              â”‚  â”‚\nâ”‚  â”‚         WHERE sp.sucursal.id = :sucursalId               â”‚  â”‚\nâ”‚  â”‚         AND sp.disponible = true                         â”‚  â”‚\nâ”‚  â”‚         ORDER BY sp.ordenVisualizacion ASC\")            â”‚  â”‚\nâ”‚  â”‚ List<SucursalProducto>                                    â”‚  â”‚\nâ”‚  â”‚ findBySucursalIdAndDisponibleTrueOrderBy...             â”‚  â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                              â†“ JPA/Hibernate\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                   BASE DE DATOS (PostgreSQL/MySQL)                 â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚\nâ”‚  â”‚ SELECT sp.* FROM sucursal_productos sp                     â”‚  â”‚\nâ”‚  â”‚ JOIN sucursales s ON sp.sucursal_id = s.id                â”‚  â”‚\nâ”‚  â”‚ JOIN productos p ON sp.producto_id = p.id                 â”‚  â”‚\nâ”‚  â”‚ WHERE s.id = 1 AND sp.disponible = true                   â”‚  â”‚\nâ”‚  â”‚ ORDER BY sp.orden_visualizacion ASC                       â”‚  â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n---\n\n## 3. Diagrama de Secuencia: Obtener MenÃº\n\n```\nFrontend             HTTP              Backend            BD\n   â”‚                  â”‚                   â”‚               â”‚\n   â”‚â”€â”€â”€ GET /api/sucursales/productos â”€â”€â†’â”‚               â”‚\n   â”‚    Headers:                          â”‚               â”‚\n   â”‚    Authorization: Bearer <JWT>       â”‚               â”‚\n   â”‚                                      â”‚               â”‚\n   â”‚                                SucursalContextFilter  â”‚\n   â”‚                                      â”‚               â”‚\n   â”‚                                â”œâ”€ Valida JWT âœ“       â”‚\n   â”‚                                â”œâ”€ Extrae username    â”‚\n   â”‚                                â”œâ”€ ThreadLocal.set()  â”‚\n   â”‚                                      â”‚               â”‚\n   â”‚                                SucursalController    â”‚\n   â”‚                                      â”‚               â”‚\n   â”‚                                â”œâ”€ getProductos()     â”‚\n   â”‚                                      â”‚               â”‚\n   â”‚                                SucursalProductoService\n   â”‚                                      â”‚               â”‚\n   â”‚                                â”œâ”€ Long sucursalId    â”‚\n   â”‚                                â”‚   = SucursalContext â”‚\n   â”‚                                â”‚     .getSucursal()  â”‚\n   â”‚                                      â”‚               â”‚\n   â”‚                                Repository            â”‚\n   â”‚                                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚\n   â”‚                                      â”‚ SQL Query:     â”‚\n   â”‚                                      â”‚ WHERE sucursal â”‚\n   â”‚                                      â”‚ _id = 1        â”‚\n   â”‚                                      â”‚ AND disponible â”‚\n   â”‚                                      â”‚ = true         â”‚\n   â”‚                                      â”‚               â”‚\n   â”‚                                      â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚\n   â”‚                                      â”‚ Resultados     â”‚\n   â”‚                                      â”‚ [              â”‚\n   â”‚                                      â”‚  {id: 1, ...}, â”‚\n   â”‚                                      â”‚  {id: 2, ...}  â”‚\n   â”‚                                      â”‚ ]              â”‚\n   â”‚                                      â”‚               â”‚\n   â”‚                                Mapeo a DTO           â”‚\n   â”‚                                      â”‚               â”‚\n   â”‚                                Serializar JSON       â”‚\n   â”‚                                      â”‚               â”‚\n   â”‚â†â”€â”€â”€ HTTP 200 OK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€               â”‚\n   â”‚     JSON:                                            â”‚\n   â”‚     [                                                â”‚\n   â”‚       {                                              â”‚\n   â”‚         \"id\": 1,                                    â”‚\n   â”‚         \"nombre\": \"Jugo\",                          â”‚\n   â”‚         \"precioBase\": 2.50,                         â”‚\n   â”‚         \"precioSucursal\": 2.50,                     â”‚\n   â”‚         \"ordenVisualizacion\": 1,                    â”‚\n   â”‚         ...                                         â”‚\n   â”‚       },                                             â”‚\n   â”‚       {                                              â”‚\n   â”‚         \"id\": 2,                                    â”‚\n   â”‚         \"nombre\": \"CafÃ©\",                          â”‚\n   â”‚         \"precioBase\": 1.50,                         â”‚\n   â”‚         \"precioSucursal\": 1.50,                     â”‚\n   â”‚         \"ordenVisualizacion\": 2,                    â”‚\n   â”‚         ...                                         â”‚\n   â”‚       }                                              â”‚\n   â”‚     ]                                                â”‚\n   â”‚                                                      â”‚\nFrontend: Renderiza menÃº\n  1. Agrupa por categorÃ­a\n  2. Ordena por ordenVisualizacion\n  3. Muestra en pantalla\n```\n\n---\n\n## 4. Diagrama: Dos Usuarios, Dos Sucursales\n\n```\nâ”Œâ”€â”€â”€ USUARIO: JUAN (Sucursal 1 - Centro) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                                                                  â”‚\nâ”‚ 1. Login                                                         â”‚\nâ”‚    POST /api/auth/login                                          â”‚\nâ”‚    {\"username\": \"juan\", \"password\": \"pass123\"}                 â”‚\nâ”‚                                                                  â”‚\nâ”‚ 2. Response                                                      â”‚\nâ”‚    {                                                             â”‚\nâ”‚      \"token\": \"eyJhbGciOiJIUzI1NiIs...\",                        â”‚\nâ”‚      \"usuario\": {                                                â”‚\nâ”‚        \"id\": 10,                                                 â”‚\nâ”‚        \"nombre\": \"Juan PÃ©rez\",                                  â”‚\nâ”‚        \"sucursal_id\": 1  â† CLAVE                               â”‚\nâ”‚      }                                                           â”‚\nâ”‚    }                                                             â”‚\nâ”‚                                                                  â”‚\nâ”‚ 3. GET /api/sucursales/productos                                â”‚\nâ”‚    Authorization: Bearer eyJhbGciOiJIUzI1NiIs...              â”‚\nâ”‚                                                                  â”‚\nâ”‚ 4. Filter: SucursalContext.setSucursal(1, \"Centro\")           â”‚\nâ”‚                                                                  â”‚\nâ”‚ 5. Query: SELECT sp FROM sucursal_productos sp                  â”‚\nâ”‚           WHERE sp.sucursal.id = 1 AND disponible = true       â”‚\nâ”‚                                                                  â”‚\nâ”‚ 6. Resultado: MenÃº de SUCURSAL 1                                â”‚\nâ”‚    ğŸ¥¤ BEBIDAS                                                    â”‚\nâ”‚       1. Jugo de Naranja        $2.50                            â”‚\nâ”‚       2. CafÃ©                   $1.50                            â”‚\nâ”‚    ğŸ REPOSTERÃA                                                â”‚\nâ”‚       1. Croissant              $1.80                            â”‚\nâ”‚                                                                  â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                              VS\nâ”Œâ”€â”€â”€ USUARIO: MARÃA (Sucursal 2 - Sur) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                                                                  â”‚\nâ”‚ 1. Login                                                         â”‚\nâ”‚    POST /api/auth/login                                          â”‚\nâ”‚    {\"username\": \"maria\", \"password\": \"pass456\"}                â”‚\nâ”‚                                                                  â”‚\nâ”‚ 2. Response                                                      â”‚\nâ”‚    {                                                             â”‚\nâ”‚      \"token\": \"eyJhbGciOiJIUzI1NiOs...\",                        â”‚\nâ”‚      \"usuario\": {                                                â”‚\nâ”‚        \"id\": 20,                                                 â”‚\nâ”‚        \"nombre\": \"MarÃ­a GarcÃ­a\",                                â”‚\nâ”‚        \"sucursal_id\": 2  â† DIFERENTE                           â”‚\nâ”‚      }                                                           â”‚\nâ”‚    }                                                             â”‚\nâ”‚                                                                  â”‚\nâ”‚ 3. GET /api/sucursales/productos                                â”‚\nâ”‚    Authorization: Bearer eyJhbGciOiJIUzI1NiOs...              â”‚\nâ”‚                                                                  â”‚\nâ”‚ 4. Filter: SucursalContext.setSucursal(2, \"Sur\")               â”‚\nâ”‚                                                                  â”‚\nâ”‚ 5. Query: SELECT sp FROM sucursal_productos sp                  â”‚\nâ”‚           WHERE sp.sucursal.id = 2 AND disponible = true       â”‚\nâ”‚                                                                  â”‚\nâ”‚ 6. Resultado: MenÃº de SUCURSAL 2                                â”‚\nâ”‚    ğŸ¥¤ BEBIDAS                                                    â”‚\nâ”‚       1. CafÃ©                   $2.00   â† Precio diferente      â”‚\nâ”‚       2. Jugo de Naranja        $3.00   â† Precio diferente      â”‚\nâ”‚    ğŸ½ï¸ COMIDAS                                                   â”‚\nâ”‚       1. Ensalada               $5.00   â† NO en Sucursal 1      â”‚\nâ”‚       2. Bebida Especial        $8.00   â† NO en Sucursal 1      â”‚\nâ”‚                                                                  â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n---\n\n## 5. Diagrama: Flujo de Admin (Cambiar Sucursal)\n\n```\nâ”Œâ”€â”€â”€ ADMIN: CARLOS (por defecto Sucursal 1) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                                                               â”‚\nâ”‚ Estado inicial:                                               â”‚\nâ”‚ â”œâ”€ Rol: ADMIN                                                â”‚\nâ”‚ â”œâ”€ Sucursal por defecto: 1 (Centro)                         â”‚\nâ”‚ â””â”€ MenÃº visible: Sucursal 1                                 â”‚\nâ”‚                                                               â”‚\nâ”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚\nâ”‚ â”‚ Hace click en \"Sucursal Centro\" (header dropdown)       â”‚ â”‚\nâ”‚ â”‚                                                          â”‚ â”‚\nâ”‚ â”‚ Modal lista:                                             â”‚ â”‚\nâ”‚ â”‚  â–¡ Sucursal Centro                                      â”‚ â”‚\nâ”‚ â”‚  â–¡ Sucursal Sur       â† Click aquÃ­                      â”‚ â”‚\nâ”‚ â”‚  â–¡ Sucursal Oeste                                       â”‚ â”‚\nâ”‚ â”‚  â–¡ Cerrar                                               â”‚ â”‚\nâ”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚\nâ”‚                                                               â”‚\nâ”‚ Frontend ejecuta:                                             â”‚\nâ”‚ GET /api/sucursales/2/productos                             â”‚\nâ”‚ Authorization: Bearer <admin_token>                         â”‚\nâ”‚                                                               â”‚\nâ”‚ Backend:                                                      â”‚\nâ”‚ â”œâ”€ Valida JWT                                               â”‚\nâ”‚ â”œâ”€ Verifica rol ADMIN                                       â”‚\nâ”‚ â”œâ”€ SucursalContext.setSucursal(2) [temporalmente]         â”‚\nâ”‚ â”œâ”€ Query: WHERE sucursal.id = 2 AND disponible = true      â”‚\nâ”‚ â””â”€ Retorna productos de Sucursal 2                         â”‚\nâ”‚                                                               â”‚\nâ”‚ Frontend:                                                     â”‚\nâ”‚ â”œâ”€ Actualiza menÃº visible                                   â”‚\nâ”‚ â”œâ”€ Muestra: \"Viendo menÃº de Sucursal Sur\"                  â”‚\nâ”‚ â””â”€ PERO sucursal por defecto sigue siendo 1                â”‚\nâ”‚                                                               â”‚\nâ”‚ Nuevo menÃº visible:                                           â”‚\nâ”‚ ğŸ¥¤ BEBIDAS                                                    â”‚\nâ”‚    1. CafÃ©                   $2.00                            â”‚\nâ”‚    2. Jugo de Naranja        $3.00                            â”‚\nâ”‚ ğŸ½ï¸ COMIDAS                                                   â”‚\nâ”‚    1. Ensalada               $5.00                            â”‚\nâ”‚    2. Bebida Especial        $8.00                            â”‚\nâ”‚                                                               â”‚\nâ”‚ Si Carlos hace logout y login:                               â”‚\nâ”‚ â†’ Vuelve a su sucursal por defecto (1 - Centro)            â”‚\nâ”‚                                                               â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n---\n\n## 6. Diagrama: Estructura de Datos en la Respuesta\n\n```\nRespuesta HTTP:\n\n{\n  \"sucursal\": {\n    \"id\": 1,\n    \"nombre\": \"Sucursal Centro\"\n  },\n  \"productos\": [\n    {\n      \"id\": 1,\n      \"nombre\": \"Jugo de Naranja\",\n      \"descripcion\": \"Jugo fresco de naranja reciÃ©n exprimida\",\n      \"categoriaProducto\": \"Bebidas\",\n      \n      \"precioBase\": 2.50,              â† Precio global del producto\n      \"precioSucursal\": 2.50,          â† Precio en ESTA sucursal\n      \n      \"sku\": \"SKU-001\",\n      \"ordenVisualizacion\": 1,         â† Orden en el menÃº\n      \"disponible\": true,              â† Disponible en esta sucursal\n      \n      \"esProductoBase\": true,\n      \"productoBaseId\": null,\n      \"nombreVariante\": null,\n      \n      \"horarioDisponibilidad\": null,   â† JSON: {\"inicio\": \"06:00\", \"fin\": \"12:00\"}\n      \"diasDisponibilidad\": null,      â† JSON: {\"dias\": [1,2,3,4,5,6]}\n      \"notas\": null                    â† Texto especÃ­fico de la sucursal\n    },\n    {\n      \"id\": 2,\n      \"nombre\": \"CafÃ©\",\n      \"descripcion\": \"CafÃ© expreso\",\n      \"categoriaProducto\": \"Bebidas\",\n      \"precioBase\": 1.50,\n      \"precioSucursal\": 1.50,          â† Mismo precio\n      \"sku\": \"SKU-002\",\n      \"ordenVisualizacion\": 2,\n      \"disponible\": true,\n      \"esProductoBase\": true,\n      \"productoBaseId\": null,\n      \"nombreVariante\": null,\n      \"horarioDisponibilidad\": null,\n      \"diasDisponibilidad\": null,\n      \"notas\": null\n    }\n  ]\n}\n```\n\n---\n\n## 7. Diagrama: Seguridad (ValidaciÃ³n JWT)\n\n```\nRequest sin token:\n  GET /api/sucursales/productos\n  Headers: (ninguno)\n  \n  âŒ Filter rechaza: \"No hay Authorization header\"\n  âŒ Response: 401 Unauthorized\n  âŒ ACCESO DENEGADO\n  \nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nRequest con token invÃ¡lido:\n  GET /api/sucursales/productos\n  Headers: Authorization: Bearer invalid_token_123\n  \n  âŒ Filter rechaza: \"JWT invalid o expirado\"\n  âŒ Response: 401 Unauthorized\n  âŒ ACCESO DENEGADO\n  \nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nRequest con token vÃ¡lido pero usuario sin sucursal:\n  GET /api/sucursales/productos\n  Headers: Authorization: Bearer eyJhbGciOiJIUzI1NiIs...\n  \n  JWT decodificado:\n  {\n    \"username\": \"usuario_sin_sucursal\",\n    \"sub\": \"usuario_sin_sucursal\",\n    ...\n  }\n  \n  Filter busca usuario en BD:\n  usuario.sucursal_id = NULL\n  \n  âŒ Filter rechaza: \"Usuario sin sucursal asignada\"\n  âŒ Response: 403 Forbidden\n  âŒ ACCESO DENEGADO\n  \nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nRequest correcto:\n  GET /api/sucursales/productos\n  Headers: Authorization: Bearer eyJhbGciOiJIUzI1NiIs...\n  \n  JWT decodificado:\n  {\n    \"username\": \"juan\",\n    \"sub\": \"juan\",\n    ...\n  }\n  \n  Filter busca usuario \"juan\" en BD:\n  usuario.id = 10\n  usuario.sucursal_id = 1\n  usuario.activo = true\n  \n  âœ… Filter: SucursalContext.setSucursal(1, \"Centro\")\n  âœ… Controller recibe y procesa\n  âœ… Repository filtra: WHERE sucursal.id = 1\n  âœ… Response: 200 OK [productos...]\n  âœ… ACCESO CONCEDIDO\n```\n\n---\n\n## 8. Resumen Visual\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                   SISTEMA COMPLETO                              â”‚\nâ”‚                                                                 â”‚\nâ”‚  FRONTEND (React Native)                                        â”‚\nâ”‚  â”œâ”€ Obtiene menÃº dinÃ¡mico                                      â”‚\nâ”‚  â”œâ”€ Agrupa por categorÃ­a                                       â”‚\nâ”‚  â”œâ”€ Ordena por orden_visualizacion                             â”‚\nâ”‚  â””â”€ Renderiza segÃºn disponibilidad                             â”‚\nâ”‚                                                                 â”‚\nâ”‚         â†• HTTP + JWT                                           â”‚\nâ”‚                                                                 â”‚\nâ”‚  BACKEND (Java Spring Boot)                                     â”‚\nâ”‚  â”œâ”€ SucursalContextFilter (ThreadLocal)                        â”‚\nâ”‚  â”œâ”€ SucursalProductoService (LÃ³gica)                           â”‚\nâ”‚  â”œâ”€ SucursalProductoRepository (Queries)                       â”‚\nâ”‚  â””â”€ SucursalController (REST API)                              â”‚\nâ”‚                                                                 â”‚\nâ”‚         â†“ JPA/Hibernate                                        â”‚\nâ”‚                                                                 â”‚\nâ”‚  BASE DE DATOS                                                  â”‚\nâ”‚  â”œâ”€ productos (global)                                         â”‚\nâ”‚  â”œâ”€ sucursal_productos (configuraciÃ³n por sucursal)           â”‚\nâ”‚  â””â”€ sucursales (tiendas)                                       â”‚\nâ”‚                                                                 â”‚\nâ”‚  RESULTADO:                                                     â”‚\nâ”‚  âœ… Cada usuario ve su menÃº                                    â”‚\nâ”‚  âœ… Precios diferentes por sucursal                            â”‚\nâ”‚  âœ… Orden visual diferente                                     â”‚\nâ”‚  âœ… Disponibilidad diferente                                   â”‚\nâ”‚  âœ… Admin puede ver todas                                      â”‚\nâ”‚  âœ… Todo automÃ¡tico y seguro                                   â”‚\nâ”‚                                                                 â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n